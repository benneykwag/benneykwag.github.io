---
layout: post
title:  "eui 프레임웍을 활용한 그리드 CRUD 프로그래밍"
date:   2016-04-13 16:25:50 +0900
categories: lecture
---

이 강좌의 결과를 확인하시려면  [여기를][eui-sample-site] 클릭하시면 샘플프로그램을 실행해 볼수 있습니다.
단지 post전송은 git에 의해 막혀있어 처리되지 않습니다. 참고하세요.

eui프레임웍은 자체 그리드를 통해 CRUD를 쉽게 처리할 수 있도록 지원합니다. 이번 강좌에서는 euigrid의 명령버튼을 포함시키고
로우를 추가,삭제,수정 등의 기능을 구현해 보도록 하겠습니다.

eui-sample 앱은 universal app로 생성하였으므로 뷰는 classic폴더에 포함됨을 알고 있자.

Step 1 : 신규 클래스 정의 및 사용할 eui클래스.
==

파일명                     | 경로          | 기능 설명
-------------------------------|:-------------|:---
Eui.sample.model.Base   | eui-sample/app | Model클래스 
Eui.sample.model.Message| eui-sample/app | Model클래스
Eui.sample.view.grid.BasicController | eui-sample/app| ViewController
Eui.sample.view.grid.BasicModel | eui-sample/app| ViewModel
Eui.sample.view.grid.Basic | eui-sample/classic| 메인클래스
Eui.sample.view.grid.RecordForm | eui-sample/classic| 입력 및 수정폼 클래스
eui.form.Panel          |   eui-core    |   테이블레이아웃용 폼패널
eui.toolbar.Command     |   eui-core    |   명령버튼 제공 
eui.grid.Panel          |   eui-core    |   CRUD등 기능제공
eui.form.Label          |   eui-core    |   폼레이블
eui.form.field.Text     |   eui-core    |   폼텍스트필드


Step 2 :  클래스 작성하기.
==

- Eui.sample.view.grid.Basic 클래스는 우리가 작성할 샘플프로그램의 메인 클래스이다. item으로 grid를 포함하고 있다.

{% highlight javascript %}

Ext.define('Eui.sample.view.grid.Basic', {
    extend: 'Ext.panel.Panel',
    xtype: 'sample-basic-grid',
    
    requires: [
        'Eui.sample.view.grid.RecordForm',      // 등록 및 수정 폼
        'Eui.sample.view.grid.BasicModel',      // 뷰모델 클래스
        'Eui.sample.view.grid.BasicController'  // 뷰컨트롤러 클래스
    ],
    controller: 'sample-basic-grid',
    viewModel: 'sample-basic-grid',
    layout: 'fit',
    items: [
        {
            xtype: 'grid',
            plugins: {  
                ptype: 'cellediting',   // 셀에디터를 추가.
                clicksToEdit: 2         // 더블클릭을 통해 에디터로 변환됨.
            },
            selModel: {     // 그리로우를 클릭시 체크박스를 통해 선택되며 체크와 체크해제
                mode: 'SIMPLE',
                selType: 'checkboxmodel'
            },
           
            bind: {
                store: '{mystore}'      // ViewModel클래스에 정의됨.
            },
            
            columns: [
                {
                    text: '#{행추가2}',
                    width: 100,
                    dataIndex: 'MSG_ID',
                    editor: {
                        bind: "{messageRecord.MSG_ID}", //뷰 모델 내부에 정의됨.
                        xtype: 'textfield'
                    }
                },
                {
                    text: 'MSG_LABEL',
                    flex: 1,
                    dataIndex: 'MSG_LABEL',
                    editor: {
                        bind: "{messageRecord.MSG_LABEL}",
                        xtype: 'textfield'
                    }
                }
            ]
        }
    ]
});
{% endhighlight %}

- Eui.sample.view.grid.BasicController 클래스를 작성한다. 이 클래스는 몸체만 있다. 구체적 구현은 이후에 하도록 한다.


{% highlight javascript %}

Ext.define('Eui.sample.view.grid.BasicController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.sample-basic-grid'
});

{% endhighlight %}

- Eui.sample.view.grid.BasicModel 클래스를 작성한다. 이 클래스는 뷰모델 클래스로 그리드에서 사용할 스토어와 그 외
formulas등의 구현이 포함되어 있다.
    - messageRecord : 그리드 로우를 선택시 선택된 레코드 정보를 담을 뷰모델 변수다.
    - mystore : Eui.sample.model.Message 모델클래스를 기반으로 하는 스토어를 정의했다.

{% highlight javascript %}

Ext.define('Eui.sample.view.grid.BasicModel', {
    extend : "Ext.app.ViewModel",
    alias: 'viewmodel.sample-basic-grid',
    requires: ['Eui.sample.model.Message'],
    formulas : {
        messageRecord: {
            bind: {
                // reference가 myGrid
                bindTo: "{myGrid.selection}",
                deep: true
            },
            get: function (b) {
                return b
            }
        }
    },
    stores: {
        mystore: {
            model: 'Eui.sample.model.Message',
            autoLoad: true
        }
    }
});

{% endhighlight %}

- Eui.sample.model.Message 모델 클래스를 정의하자. 이 클래스는 proxy CRUD를 위한 프록시 정보를 담고 있다.
주의 깊게 봐야할 것은 Eui.sample.model.Base모델을 확장하고 있고 Base모델 클래스에는 Message모델에 없는 fields요소가
정의되어 있음을 기억하고 이후 추가하도록 하자.

{% highlight javascript %}
Ext.define('Eui.sample.model.Message', {
    extend: 'Eui.sample.model.Base',
    idProperty: 'ID',
    identifier: {
        type: 'sequential',
        prefix: 'MSG'
    },
    proxy: {
        type: 'ajax',
        actionMethods: {
            read: 'GET',
            create: 'POST',
            update: 'POST',
            destroy: 'POST'
        },

        api: {
            create: 'resources/data/mygridadddata.json?create',
            read: 'resources/data/mygriddata.json?read',
            update: 'resources/data/mygridadddata.json?update',
            destroy: 'resources/data/mygriddata.json?destroy'
        },
        reader: {
            type: 'json',
            rootProperty: 'data'
        },
        writer: {
            type: 'json',
            allowSingle: false,
            writeAllFields: true
        },
        listeners: {
            exception: function (proxy, response, operation) {
                var json = Ext.decode(response.responseText);
                if (json) {
                    Ext.MessageBox.show({
                        title: 'Save Failed',
                        msg: json.message,
                        icon: Ext.MessageBox.ERROR,
                        buttons: Ext.Msg.OK
                    });
                } else
                    Ext.MessageBox.show({
                        title: 'EXCEPTION',
                        msg: operation.getError(),
                        icon: Ext.MessageBox.ERROR,
                        buttons: Ext.Msg.OK
                    });
            }
        }
    }
});
{% endhighlight %}

- Eui.sample.model.Base 클래스를 작성하자. 이 모델 클래스의 목적은 필드를 정의하고 
각 필드별로 validators를 추가하여 각 필드가 조건에 맞는 값을 가질수 있도록 하기 위함이며 이 클래스를 확장해
 다른 모델 클래스를 작성하기 위함이다.

{% highlight javascript %}

Ext.define('Eui.sample.model.Base', {
    extend: 'Ext.data.Model',
    requires: ['Ext.data.validator.Length'],
    fields: [
        {
            name: "MSG_ID",
            type: "string",
            validators: [
                {
                    type: "length",
                    min: 10,
                    minOnlyMessage: "MSG_ID must have at least 3 characters"
                }
            ]
        },
        {
            name: "MSG_LABEL",
            type: "string",
            validators: [
                {
                    type: "length",
                    min: 4,
                    minOnlyMessage: "MSG_LABEL must have at least 3 characters"
                }
            ]
        }
    ]
});

{% endhighlight %}

- 이제 Message 모델 클래스 proxy api에서 사용할 데이터 파일을 정의하자. 이 파일은 서버시이드 역할을 할 것이다.
위치는 resources/data/mygriddata.json이다.

{% highlight javascript %}
{
    "success": "true",
    "message": "Error message goes here.",
    "data": [
        {
            "ID":"111", 
            "MSG_ID": "F000000122", 
            "MSG_LABEL": "신청일자를 입력해 주세요."
        },
        {
            "ID":"112", 
            "MSG_ID": "F000000129", 
            "MSG_LABEL": "시간은 0~23 사이만 입력 가능합니다."
        },
        {
            "ID":"113", 
            "MSG_ID": "F000000130", 
            "MSG_LABEL": "성명을 입력해 주시기 바랍니다."
        },
        {
            "ID":"114", 
            "MSG_ID": "F000000131", 
            "MSG_LABEL": "날짜 형식을 yymmdd 형식으로 입력해 주세요."
        }
    ]
}
{% endhighlight %}

- 코딩이 끝났다면 실행해보도록 하자. 여기까지는 일반적인 ExtJS를 위한 코드이다.
 
![Alt text](/imgs/2016-04-15_02-07-15.png)


Step 3 : euigrid를 이용한 CRUD 코딩하기.
==
- 이제 평범한 그리드를 euigrid로 변형시키고 crud기능을 위한 commandtoolbar를 추가하도록 하겠다. 아래 추가한 코드는
모두 eui프레임웍에서 제공하는 기능이다.

{% highlight javascript %}
Ext.define('Eui.sample.view.grid.Basic', {
    extend: 'Ext.panel.Panel',
    xtype: 'sample-basic-grid',
    title: '#{행추가2}',
    requires: [
        'eui.grid.Panel',       // Ext.grid.Panel클래스를 확장한 eui-core용 그리드 클래스.
        'eui.toolbar.Command',  // 명령버튼 제공
        ...
    ],
    controller: 'sample-basic-grid',
    viewModel: 'sample-basic-grid',
    layout: 'fit',
    items: [
        {
            xtype: 'euigrid',   // 기존 grid를 수정.
            ..
            usePagingToolbar: true, // 그리드에 페이징 툴바를 추가.
            tbar: [
                {
                    showRowAddBtn: true,    // 행추가 버튼 활성화
                    showRowDelBtn: true,    // 행삭제 버튼 활성화
                    showRegBtn: true,       // 등록 버튼 활성화
                    showModBtn: true,       // 수정 버튼 활성화
                    showSaveBtn: true,      // 저장 버튼 활성화
                    showReloadBtn: true,    // 조회 버튼 활성화
                    xtype: 'commandtoolbar' // eui.toolbar.Command 클래스
                }
            ],
            
            ..
            // commandtoolbar 내부 버튼들이 발생시키는 이벤트 처리.
            listeners: {                // ViewController클래스에 정의됨.
                select: 'onGridSelect',
                regBtnClick: 'onRowReg',
                rowDeleteBtnClick: 'onRowDelete',
                modBtnClick: 'onRowMod',
                rowAddBtnClick: 'onRowAdd',
                saveBtnClick: 'onRowSave'
            },
            ...
        }
    ]
});
{% endhighlight %}

- 이제 다시 브라우저를 통해 실행해보자. 아래 그림처럼 여러 종류의 버튼들이 활성화 되는 것을 볼 수 있을 것이다.

![Alt text](/imgs/2016-04-15_02-30-15.png)
-- 진행 중.

[eui-site]: https://github.com/benneykwag/eui
[eui-sample-site]: http://benneykwag.github.io/eui/samples/Eui.sample/index.html